<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FF002F">
  <link rel="manifest" href="/manifest.json">
  <title>Tienda de Juguetes</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ================== BODY ================== */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
      color: #FF002F; /* color principal */
    }

    /* ================== PRODUCTOS ================== */
    .productos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .producto {
      width: 300px;
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 6px 15px rgba(255,0,47,0.15); /* sombra sutil en color principal */
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .producto:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(255,0,47,0.25);
    }

    /* ================== SLIDER ================== */
    .slider {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: grab;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    }

    .slider img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      transition: transform 0.3s;
      border-radius: 12px;
    }

    .slider img.active {
      display: block;
    }

    .slider-dots {
      text-align: center;
      margin-top: 8px;
    }

    .slider-dots span {
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: #ddd;
      border-radius: 50%;
      margin: 0 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .slider-dots span.active {
      background-color: #FF002F; /* color principal */
    }

    /* ================== ESTRELLAS ================== */
    .estrellas {
      font-size: 18px;
      color: #FF002F; /* dorado reemplazado por rojo principal */
      margin-bottom: 8px;
    }

    /* ================== BOTÓN ================== */
    button {
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #FF002F, #cc0026);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(255,0,47,0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255,0,47,0.3);
    }

    @media (max-width:768px) {
      .producto { width: 90%; }
    }

    /* ================== MODAL ZOOM ================== */
    #zoomModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
    }

    #zoomModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      cursor: zoom-out;
      transition: transform 0.3s;
    }
  </style>
</head>
<body>

  <h1>Mi Tienda de Juguetes</h1>

  <div id="productos" class="productos-container"></div>

  <div id="zoomModal"><img id="zoomImg"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz5jmczBym2G_VaClZiNriAqYTpF-6qDSnRzWhRaSNHtGlDHECy03PhJT0polNG00endw/exec";
    let listaProductos = [];

    async function cargarProductos() {
      const respuesta = await fetch(API_URL);
      listaProductos = await respuesta.json();
      listaProductos = listaProductos.slice(1).sort(() => Math.random() - 0.5);
      mostrarProductosEnPantalla();
    }

    function generarEstrellas(valorEstado) {
      const valor = valorEstado / 2; // convertir 0-10 a 0-5 estrellas
      let html = '';
      for(let i=0;i<5;i++){
        if(i < Math.floor(valor)) html += '★';
        else if(i < valor) html += '⯨';
        else html += '☆';
      }
      return `<span class="estrellas">${html}</span>`;
    }

    function mostrarProductosEnPantalla() {
      const contenedor = document.getElementById('productos');
      contenedor.innerHTML = listaProductos.map((producto,index)=>{
        const imagenes = [producto[7],producto[8],producto[9],producto[10],producto[11]].filter(url=>url && url.trim()!=="");
        const sliderId = `slider-${index}`;
        const dotsId = `dots-${index}`;
        const estrellas = generarEstrellas(producto[6]);

        return `
          <div class="producto">
            <div class="slider" id="${sliderId}">
              ${imagenes.map((img,i)=>`<img src="${img}" class="${i===0?'active':''}" alt="${producto[2]}">`).join('')}
            </div>
            <div class="slider-dots" id="${dotsId}">
              ${imagenes.map((_,i)=>`<span class="${i===0?'active':''}"></span>`).join('')}
            </div>
            <p><strong>Código:</strong> ${producto[1]}</p>
            <p><strong>Estado:</strong> ${estrellas}</p>
            <h3>${producto[2]}</h3>
            <p>${producto[3]}</p>
            <p><strong>Precio:</strong> S/${producto[4]}</p>
            <button onclick="reservarProducto('${producto[2]}')">Comprar</button>
          </div>
        `;
      }).join('');

      listaProductos.forEach((_,i)=>inicializarSlider(i));
    }

    async function reservarProducto(nombreProducto) {
      const respuesta = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action:"reservar", producto:nombreProducto })
      });
      const data = await respuesta.json();
      if(data.success){
        alert("Producto reservado. Se abrirá WhatsApp para concretar la compra.");
        window.open(`https://wa.me/51999999999?text=Hola,%20quiero%20comprar%20el%20producto%20${nombreProducto}`);
      } else alert(data.mensaje);
    }

    function inicializarSlider(index) {
      const slider = document.getElementById(`slider-${index}`);
      const dots = document.getElementById(`dots-${index}`).children;
      if(!slider) return;
      const imgs = slider.querySelectorAll("img");
      if(imgs.length<=1) return;

      let current = 0;
      let intervalo = setInterval(nextSlide, 3000);

      function nextSlide() {
        imgs[current].classList.remove("active");
        dots[current].classList.remove("active");
        current = (current + 1) % imgs.length;
        imgs[current].classList.add("active");
        dots[current].classList.add("active");
      }

      imgs.forEach(img=>img.addEventListener('click', ()=>{
        clearInterval(intervalo);
        document.getElementById('zoomImg').src = img.src;
        document.getElementById('zoomModal').style.display = 'flex';
      }));

      document.getElementById('zoomModal').addEventListener('click', ()=>{
        document.getElementById('zoomModal').style.display = 'none';
        intervalo = setInterval(nextSlide, 3000);
      });

      Array.from(dots).forEach((dot,i)=>{
        dot.addEventListener('click', ()=>{ cambiarSlide(i); });
      });

      let startX = 0;
      slider.addEventListener('mousedown', e=>{ startX=e.clientX; clearInterval(intervalo); });
      slider.addEventListener('mouseup', e=>{ manejarSwipe(e.clientX - startX); });
      slider.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; clearInterval(intervalo); });
      slider.addEventListener('touchend', e=>{ manejarSwipe(e.changedTouches[0].clientX - startX); });

      function manejarSwipe(diff){
        if(diff>50) current = (current-1+imgs.length)%imgs.length;
        else if(diff<-50) current = (current+1)%imgs.length;
        cambiarSlide(current);
        intervalo = setInterval(nextSlide, 3000);
      }

      function cambiarSlide(nuevo){
        imgs.forEach(img=>img.classList.remove("active"));
        Array.from(dots).forEach(dot=>dot.classList.remove("active"));
        current = nuevo;
        imgs[current].classList.add("active");
        dots[current].classList.add("active");
      }
    }

    cargarProductos();

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').then(()=>console.log('Service Worker registrado'));
    }
  </script>

</body>
</html>
